if [ ! -e "$HOME/.zplug" ]; then
    curl -sL --proto-redir -all,https https://raw.githubusercontent.com/zplug/installer/master/installer.zsh | zsh
fi
source ~/.zplug/init.zsh

# Manage zplug
zplug 'zplug/zplug', hook-build:'zplug --self-manage'

# Sane defaults from OMZ
zplug "lib/key-bindings", from:oh-my-zsh
zplug "lib/completion", from:oh-my-zsh
zplug "lib/theme-and-appearance", from:oh-my-zsh

### Plugins
zplug "lukechilds/zsh-nvm"
zplug "plugins/git", from:oh-my-zsh
zplug "plugins/systemd", from:oh-my-zsh, if:"[[ $OSTYPE == linux* ]]"
zplug "plugins/dnf", from:oh-my-zsh, if:"[[ $OSTYPE == linux* ]]"
zplug "plugins/fzf", from:oh-my-zsh
# Defer after compinit
zplug "zsh-users/zsh-completions", defer:2
zplug "zsh-users/zsh-syntax-highlighting", defer:2

### Theme
zplug "chriskempson/base16-shell", hook-load:"base16_onedark", from:github
zplug "mafredri/zsh-async", from:github
zplug "sindresorhus/pure", use:pure.zsh, from:github, as:theme

# Install plugins if there are plugins that have not been installed
if ! zplug check; then
    printf "Install? [y/N]: "
    if read -q; then
        echo; zplug install
    fi
fi

# Then, source plugins and add commands to $PATH
zplug load # --verbose

# User configuration
source "$HOME/.aliases"
# Pass arguments to command if pattern matching fails
# This fixes using carrot (^) in git for example
# https://stackoverflow.com/a/16864766/10913628
setopt NO_NOMATCH

# reclaim Ctrl-S
stty stop undef
# reclaim Ctrl-Q
stty start undef
# Disable Software Flow Control (XON/XOFF flow control)
stty -ixon

# Display fortune
if [ -e "$( which fortune )" ]; then
    echo "" && fortune -s && echo ""
fi

# Vi-mode
bindkey -v
# open command in vim (ctrl-v)
bindkey -M vicmd '^V' edit-command-line
# ctrl-p & ctrl-n to behave like arrow keys
bindkey '^P' up-line-or-beginning-search
bindkey '^N' down-line-or-beginning-search

# pure prompt
PURE_PROMPT_SYMBOL="›"
PURE_PROMPT_VICMD_SYMBOL="‹"

# dircolors
case "$OSTYPE" in
  *darwin*)
    export LSCOLORS="exfxcxdxbxegedabagacad"
    export CLICOLOR=1
    # source iTerm2 shell integration
    [ -e "${HOME}/.iterm2_shell_integration.zsh" ] && \
      source "${HOME}/.iterm2_shell_integration.zsh"
    ;;
  *linux*)
    eval "$(dircolors -b)"
    # alias xdg-open to open
    alias open='xdg-open'
    ;;
esac

# direnv
if command -v direnv > /dev/null 2>&1; then
  eval "$(direnv hook zsh)"
fi

# exa (ls replacement)
if command -v exa > /dev/null 2>&1; then
  alias ls="exa"
fi

# GPG
# use gpg-agent for ssh
if command -v gpgconf > /dev/null 2>&1; then
  export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
  gpgconf --launch gpg-agent
fi
export GPG_TTY=$(tty)
