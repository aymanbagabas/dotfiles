# Set TERM
# Set the default terminal mode to 256color mode.
set -g default-terminal 'tmux-256color'

set -g terminal-overrides 'xterm*:XT:smcup@:rmcup@'
set -as terminal-overrides ',*:Smol=\E[53m'
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'
# set-option -ga terminal-overrides ',*256col*:RGB:sitm=\E[3m'
# needed for proper nvim/tmux/base16 colors
set -ga terminal-overrides ',xterm-256color:Tc'

# rebind prefix
unbind C-b
unbind-key C-b
# set prefix C-a
set-option -g prefix M-a
bind-key M-a send-prefix

# status bar
set -g status on
# if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"
# set-hook -g window-linked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'
# set-hook -g window-unlinked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'

set -g status-position bottom

# Tabbing like functionality
#bind -n C-t new-window
#bind -n C-q kill-window
#bind -n C-p prev
#bind -n C-n next
#bind -n C-S-p swap-window -t -1
#bind -n C-S-n swap-window -t +1

# xterm-style function key sequences
set-option -gw xterm-keys on
set -g xterm-keys on

# Enable mouse
set -g mouse on

# Vi mode
setw -g mode-keys vi

unbind-key -T copy-mode-vi v
bind-key -T copy-mode-vi 'v' send-keys -X begin-selection # Begin selection in copy mode.
bind-key -T copy-mode-vi 'C-v' send-keys -X rectangle-toggle # Begin selection in copy mode.

bind-key -T copy-mode-vi 'y' send-keys -X copy-selection # Yank selection in copy mode.
#bind-key -T copy-mode-vi 'C-c' send-keys -X copy-pipe-and-cancel "xclip -se c -i"

# Copy to clipboard
set-option -s set-clipboard off
#bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -se c -i"
#bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i"


#bind-key -T copy-mode-vi MouseDown1Pane select-pane \; send-keys -X clear-selection
#bind-key -T root DoubleClick1Pane copy-mode \; send-keys -X select-word
##unbind -T copy-mode-vi MouseDragEnd1Pane
#bind-key    -T copy-mode-vi         WheelUpPane       if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "         if -Ft= '#{alternate_on}'           \"send-keys -t= up \; send-keys -t= up \; send-keys -t= up \; \"           \"                          if -Ft= '#{pane_in_mode}'               'send-keys -M ; send-keys -M ; send-keys -M ; '               'copy-mode -e -t= ; send-keys -M ; send-keys -M ; send-keys -M ; '           \"       "
#bind-key    -T copy-mode-vi         WheelDownPane     if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "         if -Ft= \"#{alternate_on}\"           \"send-keys -t= down ; send-keys -t= down ; send-keys -t= down ; \"           \" send-keys -M ; send-keys -M ; send-keys -M ; \"       "

#bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
#bind -n WheelDownPane select-pane -t= \; send-keys -M

# Allow xterm titles in terminal window, terminal scrolling with scrollbar, and setting overrides of C-Up, C-Down, C-Left, C-Right

#unbind -T prefix '"'
#bind-key -T prefix "s" split-window -v
#unbind -T prefix '%'
#bind-key -T prefix "v" split-window -v

# navigate windows using HL
bind-key -n M-H prev
bind-key -n M-L next

# swap windows using Ctrl-H and Ctrl-L
bind-key -r C-h swap-window -t -1
bind-key -r C-l swap-window -t +1

# navigate panes using hjkl
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n M-h if-shell "$is_vim" "send-keys M-h"  "select-pane -L"
bind-key -n M-j if-shell "$is_vim" "send-keys M-j"  "select-pane -D"
bind-key -n M-k if-shell "$is_vim" "send-keys M-k"  "select-pane -U"
bind-key -n M-l if-shell "$is_vim" "send-keys M-l"  "select-pane -R"
# bind-key -n M-\\ if-shell "$is_vim" "send-keys M-\\" "select-pane -l"
bind-key -T copy-mode-vi M-h select-pane -L
bind-key -T copy-mode-vi M-j select-pane -D
bind-key -T copy-mode-vi M-k select-pane -U
bind-key -T copy-mode-vi M-l select-pane -R
# bind-key -T copy-mode-vi M-\\ select-pane -l
#bind-key -n C-v if-shell "$( is_vim )" "send-keys C-v" "run-shell 'tmux set-buffer '$(xclip -o -selection clipboard)'; tmux paste-buffer'"

# navigate windows with M-S
#bind-key -n M-o if-shell "$( is_vim )" "send-keys M-o" "prev"
#bind-key -n M-p if-shell "$( is_vim )" "send-keys M-p" "next"
bind-key -T copy-mode-vi M-o prev
bind-key -T copy-mode-vi M-p next

# swap panes using Alt-j and Alt-k
bind-key -n C-M-j swap-pane -D
bind-key -n C-M-k swap-pane -U

# resize panes like vim
bind-key -r < resize-pane -L 3
bind-key -r > resize-pane -R 3
bind-key -r + resize-pane -U 1
bind-key -r - resize-pane -D 1
bind-key -r = next-layout \; previous-layout

# reload settings
bind-key R source-file ~/.tmux.conf \; display-message "Config reloaded..."

# Set titles
set -g set-titles on
set -g set-titles-string "#S / #W / #T"
setw -g automatic-rename off

# History limit
set -g history-limit 100000

# Start index from 1
set -g base-index 1
set -g pane-base-index 1

# address vim mode switching delay (http://superuser.com/a/252717/65504)
set -s escape-time 0

# Tmuxline
if-shell "test -f ~/.tmuxline.conf" "source ~/.tmuxline.conf"

# List of plugins with TPM
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'nhdaly/tmux-better-mouse-mode'
set -g @plugin 'mattdavis90/base16-tmux'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @scroll-down-exit-copy-mode "on"
set -g @scroll-in-moused-over-pane "on"
set -g @scroll-without-changing-pane "on"
set -g @emulate-scroll-for-no-mouse-alternate-buffer "on"
set -g @prevent-scroll-for-fullscreen-alternate-buffer "on"
set -g @scroll-speed-num-lines-per-scroll "3"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'

set -g @colors-base16 'onedark'

unbind -T copy-mode-vi MouseDragEnd1Pane
